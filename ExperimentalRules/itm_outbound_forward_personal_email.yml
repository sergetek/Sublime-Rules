name: "ITM: Outbound Forward to Personal Email with Sensitive Data"
description: "Detects outbound forwards to personal email addresses (free/disposable providers) with similar names/local parts, containing sensitive data or attachments."
type: "rule"
severity: "high"
source: |
  type.outbound
  and regex.imatch(subject.subject, "fw(d):.*")
  and any(recipients.to,
          (
            // if the sender is first.last@company.com, this will match variations like:
            // - first.last@gmail.com
            // - firstlast@gmail.com
            strings.levenshtein(.email.local_part, sender.email.local_part) <= 2
            or strings.ilevenshtein(.display_name, sender.display_name) <= 2
          )
          and (
            .email.domain.root_domain in $free_email_providers
            or .email.domain.root_domain in $disposable_email_providers
          )
  )

  // add any sensitive data indicators below
  and (
    any(attachments,
        .file_extension in $file_extensions_common_archives
        or strings.ilike(body.current_thread.text,
                         "*password*",
                         "*sensitive*",
                         "*protected*",
                         "*confidential*"
        )
        or any(ml.nlu_classifier(body.current_thread.text).tags,
               .name in ("invoice", "payment", "purchase_order")
        )
        or (
          .file_type == "pdf"
          and any(file.explode(.),
                  any(ml.nlu_classifier(.scan.ocr.raw).tags,
                      .name in ("invoice", "payment", "purchase_order")
                  )
          )
        )
    )
  )

detection_methods:
  - "Subject analysis"
  - "Name similarity detection"
  - "Content analysis"
  - "NLU classification"
